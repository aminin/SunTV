<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html lang="ru">
    <head>
        <title>Hello</title>
        <link rel="stylesheet" href="css/bootstrap.css"/>
        <link rel="stylesheet" href="css/legend.css"/>
        <link rel="stylesheet" href="css/smartbox.css"/>
        <!-- <link rel="stylesheet" href="css/style.css"/> -->

        <script type="text/javascript" src="js/src/libs/jquery-1.10.2.min.js"></script>
        <script type="text/javascript" src="js/src/libs/lodash.compat.min.js"></script>
        <script type="text/javascript" src="js/src/libs/event_emitter.js"></script>
        <script type="text/javascript" src="js/bootstrap.js"></script>

        <script type="text/javascript" src="js/src/sb.js"></script> 
        <script type="text/javascript" src="js/src/sb.platform.js"></script> 

        <script type="text/javascript" src="js/src/platforms/_browser/player.browser.js"></script> 
        <script type="text/javascript" src="js/src/platforms/_browser/sb.platform.browser.js"></script> 
        <script type="text/javascript" src="js/src/platforms/_browser/voicelink.browser.js"></script> 
        
        <script type="text/javascript" src="js/src/platforms/dune/player.dune.js"></script> 
        <script type="text/javascript" src="js/src/platforms/dune/sb.platform.dune.js"></script> 

        <script type="text/javascript" src="js/src/platforms/lg/player.lg.js"></script> 
        <script type="text/javascript" src="js/src/platforms/lg/sb.platform.lg.js"></script> 
        
        <script type="text/javascript" src="js/src/platforms/mag/player.mag.js"></script> 
        <script type="text/javascript" src="js/src/platforms/mag/sb.platform.mag.js"></script> 

        <script type="text/javascript" src="js/src/platforms/philips/player.philips.js"></script> 
        <script type="text/javascript" src="js/src/platforms/philips/sb.platform.philips.js"></script> 

        <script type="text/javascript" src="js/src/platforms/samsung/localstorage.js"></script> 
        <script type="text/javascript" src="js/src/platforms/samsung/player.samsung.js"></script> 
        <script type="text/javascript" src="js/src/platforms/samsung/sb.platform.samsung.js"></script> 
        <script type="text/javascript" src="js/src/platforms/samsung/voicelink.samsung.js"></script> 
        
        <script type="text/javascript" src="js/src/plugins/input.js"></script> 
        <script type="text/javascript" src="js/src/plugins/keyboard.js"></script> 
        <script type="text/javascript" src="js/src/plugins/legend.js"></script> 
        <script type="text/javascript" src="js/src/plugins/log.js"></script> 
        <script type="text/javascript" src="js/src/plugins/nav.js"></script> 
        <script type="text/javascript" src="js/src/plugins/player.js"></script> 
        <script type="text/javascript" src="js/src/plugins/voicelink.js"></script>

        <script type="text/lodash-template" id="ltpl-movie">
            <div class="nav-item menu-item movie-block" data-movie-id="{{movie_id}}">
                <img src="{{originalCover}}" alt="" class="img-responsive img-thumbnail">
                <div>
                    <h1>{{name}}</h1>
                    {% if(typeof rating_imdb_value != 'undefined' && rating_imdb_value != '0') { %}
                        <span class="pull-left">IMDB: {{rating_imdb_value}}</span>
                    {% } %}
                    <span class="pull-right">{{hit}} <span class="glyphicon glyphicon-heart"></span></span>
                    <div class="clearfix"></div>
                </div>
            </div>
        </script>

        <script type="text/lodash-template" id="ltpl-movie-single">

        </script>
        
        <script type="text/javascript">
            _.templateSettings.interpolate = /\{\{([\s\S]+?)\}\}/g;
            _.templateSettings.evaluate = /\{%([\s\S]+?)%\}/g;

            var DataProvider = {
                remoteHost:"http://online.scts.tv/",
                getCatalog:function(filter, cb){
                    var data = {};
                    data.action = [this.requestActions.getCatalogQ];
                    data.genre = [filter.genre] || undefined;
                    data.offset = [filter.offset] || [0];
                    data.size = [filter.size] || [12];
                    data.filterStreamingOnly = [filter.filterStreamingOnly] || undefined;
                    this.request(data, cb);
                },
                getMovie:function(id, cb){
                    var data = {};
                    data.action = [this.requestActions.getMovie];
                    data.movie_id = [id];
                    this.request(data, cb);
                },
                getBestsellers:function(cb){
                    var data = {};
                    data.action = [this.requestActions.getBestsellers];
                    this.request(data, cb);
                },
                getGenres:function(cb){
                    var data = {};
                    data.action = [this.requestActions.getGenres];
                    this.request(data, cb);
                },
                requestParams:{
                    type:"POST",
                    url: "http://online.scts.tv/api.php?format=ajax",
                    contentType:'application/octet-stream; charser=utf-8',
                    crossDomain:true,
                    data:null,
                    success:function(response){}
                },
                requestActions:{
                    getCatalog:'video.getCatalog',
                    getCatalogQ:'video.getCatalogQ',
                    getMovie:'videoCustom.getMovie',
                    getBestsellers:'video.getBestsellers',
                    getGenres:'video.getGenres'
                },
                request:function(data, successCb){
                    var rp = this.requestParams;
                    rp.data = data;
                    rp.success = successCb;
                    $.ajax(this.requestParams);
                }
            };

            var Controller = {
                actions: [this.showMoviesList, this.showMovieInfo, this.playMovie],
                currentAction: this.showMoviesList,
                showMoviesList:function(genre, offset, size){
                    var filter = {};
                    filter.genre = genre;
                    filter.offset = offset;
                    filter.size = size;
                    filter.filterStreamingOnly = true;
                    DataProvider.getCatalog(filter, this._renderMoviesListData);
                },
                showMovieInfo:function(id){
                    DataProvider.getMovie(id, function(data){
                        console.log(JSON.parse(data.replace(/JsHttpRequest.dataReady\((.+)\)/, '$1')));
                    });
                },
                playMovie:function(id){
                    DataProvider.getMovie(id, function(data){
                        data = JSON.parse(data.replace(/JsHttpRequest.dataReady\((.+)\)/, '$1'));
                        console.log(data);
                        files = data.js[0].response.movie.files;
                        var streams = [];
                        for(var i = 0; i < files.length; i++){
                            if(typeof files[i].links.streams == 'object'){
                                for(str in files[i].links.streams){
                                    if(str != undefined){
                                        streams.push(files[i].links.streams[str])
                                    }
                                }
                            }
                        }
                        console.log(streams);
                        $('.wrap').hide();
                        $('#smart_player').show();
                        $('body').css('background','transparent');
                        Player.play({url:streams[streams.length-1],type:'vod'});
                    });
                },
                stopMovie:function(){
                    Player.stop();
                    $('#smart_player').hide();
                    $('body').css('background','linear-gradient(210deg, #192342 0%,#6274BB 32%,#243C6E 64%,#03123F 100%)');
                    $('.wrap').show();
                },
                _renderMoviesListData:function(data){
                    data = JSON.parse(data.replace(/JsHttpRequest.dataReady\((.+)\)/, '$1'));
                    console.log(data);
                    movies = data.js[0].response.movies;
                    if(movies != undefined) {
                        html = '';
                        for (var i=0; i<movies.length; i++) {
                            movies[i].originalCover = DataProvider.remoteHost + movies[i].originalCover;
                            html = html + (_.template($('script#ltpl-movie').text()))(movies[i]);
                        }
//                        parentBlock = $('.movies-stack').parent();
//
//                        $('.movies-stack').removeClass('.movies-stack').remove();
//                        parentBlock.appendChild('<div class="movies-stack-append"></div>');
//                        $('.movies-stack-append').html(html).removeClass('.movies-stack-append').addClass('.movies-stack');
//
//                        parentBlock.prependChild('<div class="movies-stack-prepend"></div>');
//                        $('.movies-stack-prepend').html(html).removeClass('.movies-stack-prepend').addClass('.movies-stack');

                        $('.movies-stack').html(html);
                        $$nav.current($('.movies-stack').find($$nav.area_selector).filter(':visible').eq(0));
                    }
                }
            };
            SB.ready(function(){
                $$nav.on();
                $$legend.show();
                Player.play();
                $(function(){
                    var offset = 0;
                    var genre = undefined;
                    var elsForPage = 12;
                    Controller.showMoviesList(genre, offset, elsForPage);

                    $('.movies-stack').delegate('div.movie-block','click',function(ev){
                        var id = $(ev.currentTarget).attr('data-movie-id');
                        console.log(id);
                        Controller.playMovie(id);
                    });
                    $('.movies-stack').delegate('div.movie-block', 'nav_key:up nav_key:down', function(ev){
                        var el = ev.currentTarget;
                        var dir = ev.keyName;
                        var navs = $('.movies-stack').find($$nav.area_selector).filter(':visible');
                        var nextSibling = $$nav.findNav($(el), dir, navs);
                        console.log(el,nextSibling,dir);
                        if(!nextSibling){
                            if(dir == 'up'){
                                offset -= elsForPage;
                                if(offset < 0) offset = 0;
                            }else if(dir == 'down'){
                                offset += elsForPage;
                                //TODO: upper bound
                            }
                            Controller.showMoviesList(genre, offset, elsForPage);

                        }
                    })
                    $(document.body).on('nav_key:red',function(evy){
                        Controller.stopMovie();
                    });
                    $(document.body).on('nav_key:green',function(evy){
                    })
                });
            })
        </script>
        <style type="text/css">
            @font-face{
                font-family: OpenSansLight;
                src: url(fonts/OpenSans-Light.ttf);
            }
            * {
                outline: none !important;
            }
            body {
                background: linear-gradient(210deg, #192342 0%,#6274BB 32%,#243C6E 64%,#03123F 100%);
                font-family: OpenSansLight;
                height: 100vh;
                position: relative;
            }
            .container-fluid {
                padding-right: 1%;
                padding-left: 1%;
            }
            .layout .col-lg-3 {
                padding-left: 2%;
                padding-right: 0%;
            }
            .layout .row {
                margin-right: 0;
            }
            .nav.nav-pills.nav-stacked{
                margin-bottom: 6vh;
            }
            .nav.nav-pills.nav-stacked li {
                margin: 0 0;
                border-radius: 0px;
                height: 5.7vh;
                font-size: 2vh;
                border-top: 1px solid rgba(61, 100, 202, 0.3);
                border-bottom: 1px solid rgba(25, 56, 113, 0.3);
                border-right: 5px solid transparent;
                background-color: rgba(255,255,255,0);
                color: #fff;
            }
            .nav.nav-pills.nav-stacked li:hover, .nav.nav-pills.nav-stacked li.focus, .nav.nav-pills.nav-stacked li:focus{
                background-color: rgba(255,255,255,0.2);
                border-right: 5px solid red;
                transition: border-right 0.2s linear, background-color 0.2s linear;
            }
            .nav > li > a {
                color: #fff;
            }
            .nav > li > a:hover, .nav > li > a:focus {
                background-color: transparent;
            }
            .nav > li:first-child{
                border-top: none !important;
            }
            .nav > li:last-child{
                border-bottom: none !important;
            }
            .layout .col-lg-9{
                padding-left: 5%;
                height: 100%;
                padding-right: 0;
            }

            .search-box {
                position:relative;
            }
            .movies-stack {
                position: relative;
                height: 85vh;
                display: block;
                transition: 0.5s ease-out;
            }
            .movies-stack.moving-up{
                transform: translate(0,85vh);
                opacity: 0;
            }
            .movies-stack.moving-down{
                transform: translate(0,-85vh);
                opacity: 0;
            }
            .movies-stack > div {
                cursor: pointer;
                display: block;
                float: left;
                margin-right: 1.98%;
                width: 22.7%;
                overflow: hidden;
                height: 25vh;
                position: relative;
                margin-bottom: 1vh;
                border-top: 3px solid transparent;
                border-bottom: 3px solid transparent;
            }
            .movies-stack > div:hover, .movies-stack > div.focus {
                border-top: 3px solid red;
                border-bottom: 3px solid red;
                transform: scale(1.1,1.1);
                transition: border 0.5s ease;
            }
            .movies-stack > div >img.img-thumbnail{
                width: 100%;
                border-radius: 0px;
            }
            .movies-stack > div > div {
                background: rgba(255,255,255,0.5);
                border-bottom:5px solid #fff;
                position: absolute;
                width: 100%;
                bottom: 0px;
                padding: 0 6% 6%;
            }
            .movies-stack > div h1 {
                margin-top: 5%;
                margin-bottom: 2%;
                font-size: 2.28vh;
            }
            .movies-stack span.glyphicon.glyphicon-heart {
                color: red;
            }
            .top-line {
                height: 15vh;
            }
            #smart_player {
                position: absolute;
                z-index: 10;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="container-fluid layout">
                <div class="row top-line"></div>
                <div class="col-lg-2">
                    <div class="row">
                        <ul class="nav nav-pills nav-stacked">
                          <li class="nav-item menu-item" role="presentation"><a href="#42">Боевик</a></li>
                          <li class="nav-item menu-item" role="presentation"><a href="#33">Комедии</a></li>
                          <li class="nav-item menu-item" role="presentation"><a href="#35">Мультфильмы</a></li>
                          <li class="nav-item menu-item" role="presentation"><a href="#39">Драма</a></li>
                          <li class="nav-item menu-item" role="presentation"><a href="#32">Ужасы</a></li>
                          <!--<li class="nav-item menu-item" role="presentation"><a href="#43">Документальное</a></li>-->
                          <!--<li class="nav-item menu-item" role="presentation"><a href="#34">Аниме</a></li>-->
                        </ul>
                    </div>
                    <div class="clearfix"></div>
                    <div class="row form-group search-box">
                        <input type="text" class="form-control" id="movieSearch">
                        <span class="glyphicon glyphicon-search form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-lg-10">
                    <div class="row movies-stack">

                    </div>
                </div>
            </div>
        </div>
    </body>
</html>